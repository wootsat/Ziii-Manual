<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ziii Manual</title>
  <style>
    :root {
      --book-width: 90vmin;
      --speed: 0.6s;
    }

    body {
      background: #000;
      margin: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      user-select: none;
    }

    #viewport {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #drag-wrapper {
      position: absolute;
      transform-origin: center center;
      will-change: transform;
      cursor: grab;
      display: flex;
      justify-content: center;
      align-items: center;

      transform: translateZ(0);
      backface-visibility: hidden;
    }
    #drag-wrapper:active { cursor: grabbing; }

    .book {
      position: relative;
      width: calc(var(--book-width) / 2);
      height: calc(var(--book-width) * 0.7);
      transition: transform var(--speed);
      transform-style: preserve-3d;
      perspective: 5000px;
      backface-visibility: hidden;
      transform: translateZ(0);
      will-change: transform;
    }

    .page {
      position: absolute;
      inset: 0;
      transform-origin: left;
      transform-style: preserve-3d;
      transition: transform var(--speed);
      cursor: pointer;

      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .front, .back {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      background: transparent;
      display: flex;
      justify-content: center;
      align-items: center;
      transform: translateZ(0);
    }

    .back { transform: rotateY(180deg) translateZ(0); }

    img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;

      image-rendering: auto;
      image-rendering: smooth;
      image-rendering: high-quality;
      -ms-interpolation-mode: bicubic;

      transform: translateZ(0);
      backface-visibility: hidden;
      will-change: transform;

      -webkit-transform-style: preserve-3d;
      transform-style: preserve-3d;
    }

    .flipped { transform: rotateY(-180deg) translateZ(0); }

    #zoom-info {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #777;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="zoom-info">Scroll: Zoom to Cursor | Drag: Move | Tap: Flip</div>

  <div id="viewport">
    <div id="drag-wrapper">
      <div class="book" id="book"></div>
    </div>
  </div>

  <script>
    const totalImages = 58;
    const folderPath = "images/";
    const extension = ".jpg";

    const book = document.getElementById("book");
    const dragWrapper = document.getElementById("drag-wrapper");

    // --- Drag vs Click threshold (fix for tiny mouse movement) ---
    const DRAG_THRESHOLD = 6; // pixels (raise/lower to taste)

    // Initial state
    let scale = 1;
    let pos = { x: 0, y: 0 };
    let isDragging = false;
    let wasDragged = false;
    let startMouse = { x: 0, y: 0 };
    let dragStart = { x: 0, y: 0 };

    // --- 1) ZOOM TO CURSOR ---
    window.addEventListener(
      "wheel",
      (e) => {
        e.preventDefault();

        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.min(Math.max(0.1, scale * delta), 6);

        const mouseX = e.clientX - window.innerWidth / 2;
        const mouseY = e.clientY - window.innerHeight / 2;

        pos.x = mouseX - (mouseX - pos.x) * (newScale / scale);
        pos.y = mouseY - (mouseY - pos.y) * (newScale / scale);

        scale = newScale;
        updateTransform();
      },
      { passive: false }
    );

    // --- 2) DRAGGING WITH THRESHOLD ---
    window.addEventListener("mousedown", (e) => {
      isDragging = true;
      wasDragged = false;

      dragStart = { x: e.clientX, y: e.clientY };
      startMouse = { x: e.clientX - pos.x, y: e.clientY - pos.y };
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;

      // Only count as dragging after a small threshold
      if (!wasDragged && Math.hypot(dx, dy) > DRAG_THRESHOLD) {
        wasDragged = true;
      }

      // Only move the book once we've exceeded the threshold
      if (wasDragged) {
        pos.x = e.clientX - startMouse.x;
        pos.y = e.clientY - startMouse.y;
        updateTransform();
      }
    });

    window.addEventListener("mouseup", () => {
      isDragging = false;
      // Small delay to prevent click/flip when releasing a real drag
      setTimeout(() => {
        wasDragged = false;
      }, 50);
    });

    function updateTransform() {
      dragWrapper.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0) scale(${scale})`;
    }

    // --- 3) PAGE INITIALIZATION ---
    const numOfPapers = Math.ceil(totalImages / 2);
    let currentState = 1;
    const maxState = numOfPapers + 1;

    function init() {
      for (let i = 1; i <= numOfPapers; i++) {
        const page = document.createElement("div");
        page.className = "page";
        page.id = `p${i}`;
        page.style.zIndex = numOfPapers - i + 1;

        const frontNum = (i - 1) * 2;
        const backNum = frontNum + 1;

        page.innerHTML = `
          <div class="front" onclick="handleTap(event, 'next')">
            <img src="${folderPath}${frontNum}${extension}" loading="eager" decoding="sync" onerror="this.style.opacity='0'">
          </div>
          <div class="back" onclick="handleTap(event, 'prev')">
            <img src="${folderPath}${backNum}${extension}" loading="eager" decoding="sync" onerror="this.style.opacity='0'">
          </div>
        `;
        book.appendChild(page);
      }
    }

    function handleTap(e, direction) {
      // Allow small mouse jitter: only block if it was a REAL drag
      if (wasDragged) return;

      if (direction === "next") goNextPage();
      else goPrevPage();
    }

    function goNextPage() {
      if (currentState < maxState) {
        const paper = document.getElementById(`p${currentState}`);
        if (currentState === 1) book.style.transform = "translate3d(50%,0,0)";
        paper.classList.add("flipped");
        paper.style.zIndex = currentState;
        if (currentState === numOfPapers) book.style.transform = "translate3d(100%,0,0)";
        currentState++;
      }
    }

    function goPrevPage() {
      if (currentState > 1) {
        currentState--;
        const paper = document.getElementById(`p${currentState}`);
        if (currentState === 1) book.style.transform = "translate3d(0%,0,0)";
        else if (currentState === numOfPapers) book.style.transform = "translate3d(50%,0,0)";
        paper.classList.remove("flipped");
        paper.style.zIndex = numOfPapers - currentState + 1;
      }
    }

    init();
  </script>
</body>
</html>

